<?php/** * API Pointage - Version nettoyÃ©e * GÃ¨re uniquement les lectures/stats (les modifications sont gÃ©rÃ©es par WebSocket) */header('Content-Type: application/json');date_default_timezone_set('Europe/Paris');class ApiHandler {    private $pdo;        public function __construct() {        try {            $this->pdo = new PDO("sqlite:../Presences.db");            $this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);        }        catch(PDOException $e) {            $this->sendError('Database connection failed: ' . $e->getMessage());        }    }        public function handleRequest() {        try {            if ($_SERVER['REQUEST_METHOD'] !== 'GET') {                throw new Exception('Seules les requÃªtes GET sont supportÃ©es');            }                        $action = $_GET['action'] ?? null;            if (!$action) {                throw new Exception('Action non spÃ©cifiÃ©e');            }                        switch ($action) {                case 'getStatsDay':                    $this->getStatsDay();                    break;                                    case 'getStatsWeek':                    $this->getStatsWeek();                    break;                                    case 'getPartnersWeek':                    $this->getPartnersWeek();                    break;                                    default:                    throw new Exception('Action inconnue: ' . $action);            }        }        catch(Exception $e) {            $this->sendError($e->getMessage());        }    }        // ==================== STATISTIQUES ====================        /**     * Statistiques du jour (individuals + partners)     */    private function getStatsDay() {        if (!isset($_GET['date'])) {            throw new Exception('Date requise');        }                try {            $date = $_GET['date'];                        // Stats individuals            $stmt = $this->pdo->prepare("                SELECT                     COUNT(*) as count,                    SUM(CASE WHEN has_left = 0 THEN 1 ELSE 0 END) as present_count,                    SUM(                        CAST(SUBSTR(duration, 1, 2) AS INTEGER) * 60 +                         CAST(SUBSTR(duration, 4, 2) AS INTEGER)                    ) as total_minutes                FROM individuals                 WHERE DATE(created_at) = DATE(?)            ");            $stmt->execute([$date]);            $individualStats = $stmt->fetch(PDO::FETCH_ASSOC);                        // Stats partners            $stmt = $this->pdo->prepare("                SELECT                     SUM(size) as count,                    SUM(                        CAST(SUBSTR(total_duration, 1, 2) AS INTEGER) * 60 +                         CAST(SUBSTR(total_duration, 4, 2) AS INTEGER)                    ) as total_minutes                FROM partners                 WHERE DATE(created_at) = DATE(?)            ");            $stmt->execute([$date]);            $partnerStats = $stmt->fetch(PDO::FETCH_ASSOC);                        // Liste partners du jour            $stmt = $this->pdo->prepare("                SELECT *                 FROM partners                 WHERE DATE(created_at) = DATE(?)                ORDER BY name ASC            ");            $stmt->execute([$date]);            $dayPartners = $stmt->fetchAll(PDO::FETCH_ASSOC);                        // Calculs            $indivMinutes = $individualStats['total_minutes'] ?? 0;            $partnerMinutes = $partnerStats['total_minutes'] ?? 0;            $totalMinutes = $indivMinutes + $partnerMinutes;                        $this->sendResponse([                'individuals_count' => $individualStats['count'] ?: 0,                'present_count' => $individualStats['present_count'] ?: 0,                'individuals_hours' => $this->formatMinutes($indivMinutes),                'partners_count' => $partnerStats['count'] ?: 0,                'partners_hours' => $this->formatMinutes($partnerMinutes),                'total_count' => (intval($individualStats['count']) + intval($partnerStats['count'])) ?: 0,                'total_hours' => $this->formatMinutes($totalMinutes),                'day_partners' => $dayPartners            ]);        }        catch(PDOException $e) {            throw new Exception('Erreur base de donnÃ©es: ' . $e->getMessage());        }    }        /**     * Statistiques de la semaine (lundi-dimanche)     */    private function getStatsWeek() {        if (!isset($_GET['date'])) {            throw new Exception('Date requise');        }                try {            $date = $_GET['date'];                        // Calculer lundi et dimanche de la semaine            $selectedDate = new DateTime($date);                        // Forcer au lundi de la semaine (ISO-8601)            $monday = clone $selectedDate;            $dayOfWeek = (int)$monday->format('N'); // 1=lundi, 7=dimanche            if ($dayOfWeek != 1) {                $monday->modify('-' . ($dayOfWeek - 1) . ' days');            }                        // Dimanche = lundi +6 jours            $sunday = clone $monday;            $sunday->modify('+6 days');                        // Stats individuals            $stmt = $this->pdo->prepare("                SELECT                     COUNT(*) as count                FROM individuals                 WHERE DATE(arrival_time) BETWEEN ? AND ?            ");            $stmt->execute([$monday->format('Y-m-d'), $sunday->format('Y-m-d')]);            $indivStats = $stmt->fetch(PDO::FETCH_ASSOC);                        // Calcul temps fixe : 1h30 par personne            $indivCount = intval($indivStats['count']);            $indivMinutes = $indivCount * 90;                        // Stats partners            $stmt = $this->pdo->prepare("                SELECT                     SUM(size) as count,                    SUM(                        CAST(SUBSTR(total_duration, 1, INSTR(total_duration, ':') - 1) AS INTEGER) * 60 +                         CAST(SUBSTR(total_duration, INSTR(total_duration, ':') + 1, 2) AS INTEGER)                    ) as total_minutes                FROM partners                 WHERE DATE(created_at) BETWEEN ? AND ?            ");            $stmt->execute([$monday->format('Y-m-d'), $sunday->format('Y-m-d')]);            $partnerStats = $stmt->fetch(PDO::FETCH_ASSOC);                        $partnerCount = intval($partnerStats['count']);            $partnerMinutes = intval($partnerStats['total_minutes']);                        $this->sendResponse([                'individuals_count' => $indivCount,                'individuals_hours' => $this->formatMinutes($indivMinutes),                'partners_count' => $partnerCount,                'partners_hours' => $this->formatMinutes($partnerMinutes),                'total_count' => $indivCount + $partnerCount,                'total_hours' => $this->formatMinutes($indivMinutes + $partnerMinutes)            ]);        }        catch(Exception $e) {            throw new Exception('Erreur stats semaine: ' . $e->getMessage());        }    }            /**     * Liste des partenaires pour toute la semaine (lundi-dimanche)     */    private function getPartnersWeek() {        if (!isset($_GET['date'])) {            throw new Exception('Date requise');        }                try {            $date = $_GET['date'];                        // Calculer lundi et dimanche de la semaine            $selectedDate = new DateTime($date);                        // Forcer au lundi de la semaine (ISO-8601)            $monday = clone $selectedDate;            $dayOfWeek = (int)$monday->format('N'); // 1=lundi, 7=dimanche            if ($dayOfWeek != 1) {                $monday->modify('-' . ($dayOfWeek - 1) . ' days');            }                        // Dimanche = lundi +6 jours            $sunday = clone $monday;            $sunday->modify('+6 days');                        $stmt = $this->pdo->prepare("                SELECT *                 FROM partners                 WHERE DATE(created_at) BETWEEN ? AND ?                ORDER BY created_at ASC, name ASC            ");            $stmt->execute([$monday->format('Y-m-d'), $sunday->format('Y-m-d')]);            $partners = $stmt->fetchAll(PDO::FETCH_ASSOC);                        $this->sendResponse($partners);        }        catch(PDOException $e) {            throw new Exception('Erreur base de données: ' . $e->getMessage());        }    }    // ==================== HELPERS ====================        /**     * Convertit minutes en format HH:MM     */    private function formatMinutes($minutes) {        if (!$minutes) return "00:00";        $hours = floor($minutes / 60);        $mins = $minutes % 60;        return sprintf("%02d:%02d", $hours, $mins);    }        /**     * Envoie rÃ©ponse JSON succÃ¨s     */    private function sendResponse($data) {        echo json_encode($data);        exit;    }        /**     * Envoie rÃ©ponse JSON erreur     */    private function sendError($message) {        http_response_code(400);        echo json_encode(['error' => $message]);        exit;    }}// Gestionnaire d'erreurs globalset_error_handler(function ($errno, $errstr, $errfile, $errline) {    throw new ErrorException($errstr, $errno, 0, $errfile, $errline);});// ExÃ©cution$api = new ApiHandler();$api->handleRequest();